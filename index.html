<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jar2Docker - ä¸€é”®æ„å»º & æ¨é€ Docker é•œåƒ</title>
    
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon-32x32.png">
    
    <link href="static/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/fontawesome/all.min.css">
    <link rel="stylesheet" href="static/codemirror/css/codemirror.min.css">
    <link rel="stylesheet" href="static/codemirror/css/monokai.min.css">
    <style>
        body { padding-top: 2rem; background: #f8f9fa; }
        .card { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 2rem; }
        .log-container {
            background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            height: 500px; overflow-y: auto; padding: 0; border-radius: 0;
            white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.6;
            position: relative;
        }
        .log-line {
            padding: 4px 12px 4px 60px; border-left: 3px solid transparent;
            position: relative; transition: background 0.1s;
        }
        .log-line:hover { background: rgba(255,255,255,0.05); }
        .log-line-number {
            position: absolute; left: 8px; top: 4px; color: #858585;
            font-size: 11px; user-select: none; width: 40px; text-align: right;
        }
        .log-line.error { border-left-color: #f48771; background: rgba(244, 135, 113, 0.05); }
        .log-line.success { border-left-color: #89d185; background: rgba(137, 209, 133, 0.05); }
        .log-line.warning { border-left-color: #e5c07b; background: rgba(229, 192, 123, 0.05); }
        .log-line.info { border-left-color: #61afef; }
        .log-line.error .log-content { color: #f48771; }
        .log-line.success .log-content { color: #89d185; }
        .log-line.warning .log-content { color: #e5c07b; }
        .log-line.info .log-content { color: #61afef; }
        .log-line.highlight { background: rgba(255, 255, 0, 0.15) !important; }
        .log-timestamp {
            color: #858585; font-size: 11px; margin-right: 8px;
        }
        .log-toolbar {
            background: #252526; border-bottom: 1px solid #3e3e42;
            padding: 8px 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
        }
        .log-toolbar input, .log-toolbar select {
            background: #3c3c3c; border: 1px solid #555; color: #d4d4d4;
            padding: 4px 8px; border-radius: 3px; font-size: 12px;
        }
        .log-toolbar input:focus, .log-toolbar select:focus {
            outline: none; border-color: #007acc; background: #2d2d2d;
        }
        .log-toolbar .btn-sm {
            padding: 4px 10px; font-size: 12px;
        }
        .log-stats {
            color: #858585; font-size: 11px; margin-left: auto;
        }
        #logSearch { min-width: 200px; }
        .template-preview {
            background: #f1f3f5; padding: 1rem; border-radius: 0.5rem;
            font-family: 'Courier New', monospace; font-size: 0.9em;
            max-height: 200px; overflow-y: auto;
        }
        .btn-build { position: relative; }
        .spinner { display: none; margin-left: 0.5rem; }
        #imagename, #tag { font-family: 'Courier New', monospace; }
        .CodeMirror {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            height: 320px;
            font-size: 14px;
        }
        .CodeMirror-scroll {
            max-height: 320px;
            overflow-y: auto !important;
        }
        .CodeMirror-focused {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-box-open text-primary"></i> App2Docker</h1>
            <p class="lead text-muted">ä¸Šä¼  Java/Node.js åº”ç”¨ï¼Œä¸€é”®æ„å»ºå¹¶æ¨é€ Docker é•œåƒ</p>
        </div>

        <!-- ä¸Šä¼ æ„å»ºå¡ç‰‡ -->
        <div class="card">
            <div class="card-header bg-success text-white d-flex flex-wrap gap-2 justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ åº”ç”¨å¹¶æ„å»º</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-light btn-sm" id="openConfigBtn">
                        <i class="fas fa-cog"></i> Docker é…ç½®
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="manageTemplateBtn">
                        <i class="fas fa-sliders-h"></i> ç®¡ç†æ¨¡æ¿
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data" accept-charset="UTF-8">
                    <div class="mb-3">
                        <label class="form-label">é¡¹ç›®ç±»å‹ <span class="text-danger">*</span></label>
                        <select name="project_type" id="projectType" class="form-select" required>
                            <option value="jar">Java åº”ç”¨ï¼ˆJARï¼‰</option>
                            <option value="nodejs">Node.js åº”ç”¨</option>
                        </select>
                        <div class="form-text">é€‰æ‹©æ‚¨è¦æ„å»ºçš„é¡¹ç›®ç±»å‹</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©æ–‡ä»¶ <span class="text-danger">*</span></label>
                        <input type="file" name="app_file" id="appFile" class="form-control" accept=".jar" required>
                        <div class="form-text" id="fileTypeHint">æ”¯æŒ .jar æ–‡ä»¶</div>
                    </div>

                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-12">
                            <label class="form-label">ä½¿ç”¨æ¨¡æ¿</label>
                            <select name="template" id="templateSelect" class="form-select">
                            </select>
                            <div class="form-text">é€‰æ‹©é¢„è®¾ Dockerfile æ¨¡æ¿</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">é•œåƒåç§°</label>
                            <input type="text" name="imagename" id="imagename" class="form-control" placeholder="myapp/demo" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">æ ‡ç­¾</label>
                            <input type="text" name="tag" id="tag" class="form-control" value="latest">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="push" class="form-check-input" id="pushImage">
                                <label class="form-check-label" for="pushImage">æ„å»ºåæ¨é€</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-build w-100">
                        <i class="fas fa-hammer"></i> å¼€å§‹æ„å»º
                        <span class="spinner-border spinner-border-sm spinner ms-2" role="status"></span>
                    </button>
                </form>
            </div>
        </div>

        <!-- å¯¼å‡ºé•œåƒå¡ç‰‡ -->
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-file-export"></i> å¯¼å‡º Docker é•œåƒ</h5>
            </div>
            <div class="card-body">
                <form id="exportForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">é•œåƒåç§°</label>
                        <input type="text" name="export_image" class="form-control" placeholder="myapp/demo" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">æ ‡ç­¾</label>
                        <input type="text" name="export_tag" class="form-control" value="latest">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">å‹ç¼©æ–¹å¼</label>
                        <select name="export_compress" class="form-select">
                            <option value="none">ä¸å‹ç¼© (.tar)</option>
                            <option value="gzip">GZIP (.tar.gz)</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-download"></i> å¯¼å‡ºé•œåƒ
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="exportSpinner"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Docker Compose é•œåƒå¯¼å‡º -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-diagram-project"></i> Docker Compose é•œåƒå¯¼å‡º</h5>
            </div>
            <div class="card-body">
                <form id="composeForm">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="compose-file-tab" data-bs-toggle="tab" data-bs-target="#compose-file" type="button" role="tab">
                                <i class="fas fa-file-upload"></i> ä¸Šä¼ æ–‡ä»¶
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="compose-text-tab" data-bs-toggle="tab" data-bs-target="#compose-text" type="button" role="tab">
                                <i class="fas fa-edit"></i> æ–‡æœ¬è¾“å…¥
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="compose-file" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">ä¸Šä¼  docker-compose.yml</label>
                                <input type="file" class="form-control" id="composeFileInput" accept=".yml,.yaml,.YML,.YAML,.txt">
                                <div class="form-text">è‡ªåŠ¨æå– compose æ–‡ä»¶å†…çš„é•œåƒ</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="compose-text" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">ç›´æ¥è¾“å…¥ docker-compose.yml å†…å®¹</label>
                                <div id="composeTextEditor"></div>
                                <div class="form-text">ç²˜è´´æˆ–è¾“å…¥å®Œæ•´çš„ docker-compose.yml å†…å®¹ï¼ˆæ”¯æŒè¯­æ³•é«˜äº®ï¼‰</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-info" id="parseComposeBtn">
                            <i class="fas fa-search"></i> è§£æé•œåƒ
                        </button>
                    </div>
                </form>
                <div class="table-responsive mt-3 d-none" id="composeResult">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                        <h6 class="mb-0">å…±æ‰¾åˆ° <span id="composeImageCount">0</span> ä¸ªé•œåƒ</h6>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="form-check me-2">
                                <input type="checkbox" class="form-check-input" id="selectAllImages">
                                <label class="form-check-label" for="selectAllImages">å…¨é€‰</label>
                            </div>
                            <select class="form-select form-select-sm" id="composeCompress" style="width: auto;">
                                <option value="none">ä¸å‹ç¼© (.tar)</option>
                                <option value="gzip">GZIP (.tar.gz)</option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="downloadSelectedBtn">
                                <i class="fas fa-download"></i> ä¸‹è½½é€‰ä¸­
                            </button>
                        </div>
                    </div>
                    <table class="table table-striped align-middle" id="composeImagesTable">
                        <thead>
                            <tr>
                                <th style="width:40px;"></th>
                                <th>æœåŠ¡</th>
                                <th>é•œåƒ</th>
                                <th>æ ‡ç­¾/æ‘˜è¦</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ„å»ºæ—¥å¿—å¡ç‰‡ -->
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal"></i> æ„å»ºæ—¥å¿—ç®¡ç†å™¨</h5>
            </div>
            <div class="card-body p-0">
                <!-- æ—¥å¿—å·¥å…·æ  -->
                <div class="log-toolbar">
                    <input type="text" id="logSearch" placeholder="ğŸ” æœç´¢æ—¥å¿—..." class="form-control-sm">
                    <select id="logLevel" class="form-select-sm">
                        <option value="all">å…¨éƒ¨çº§åˆ«</option>
                        <option value="error">âŒ é”™è¯¯</option>
                        <option value="warning">âš ï¸ è­¦å‘Š</option>
                        <option value="success">âœ… æˆåŠŸ</option>
                        <option value="info">â„¹ï¸ ä¿¡æ¯</option>
                    </select>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" id="autoScrollToggle" title="è‡ªåŠ¨æ»šåŠ¨">
                            <i class="fas fa-arrow-down"></i> è‡ªåŠ¨
                        </button>
                        <button class="btn btn-outline-secondary" id="lineNumberToggle" title="è¡Œå·">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button class="btn btn-outline-secondary" id="timestampToggle" title="æ—¶é—´æˆ³">
                            <i class="fas fa-clock"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" id="copyLog" title="å¤åˆ¶æ—¥å¿—">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-outline-success" id="downloadLog" title="ä¸‹è½½æ—¥å¿—">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-outline-danger" id="clearLog" title="æ¸…ç©ºæ—¥å¿—">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="log-stats">
                        <span id="logCount">0</span> è¡Œ | 
                        <span id="filteredCount">0</span> å·²æ˜¾ç¤º
                    </div>
                </div>
                <!-- æ—¥å¿—å®¹å™¨ -->
                <div class="log-container" id="buildLog"></div>
            </div>
        </div>
    </div>

    <!-- Docker é…ç½® Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cog"></i> Docker é…ç½®</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm" accept-charset="UTF-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Registry åœ°å€</label>
                                <input type="text" name="registry" class="form-control" placeholder="docker.io">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">é•œåƒå‰ç¼€ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" name="registry_prefix" class="form-control" placeholder="your-namespace">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è´¦å·</label>
                                <input type="text" name="username" class="form-control" value="">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">å¯†ç </label>
                                <input type="password" name="password" class="form-control" value="">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">æš´éœ²ç«¯å£</label>
                                <input type="number" name="expose_port" class="form-control" value="8080">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="form-check">
                                    <input type="checkbox" name="default_push" class="form-check-input" id="defaultPush">
                                    <label class="form-check-label" for="defaultPush">é»˜è®¤æ¨é€é•œåƒ</label>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save"></i> ä¿å­˜é…ç½®
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ¿ç®¡ç† Modal -->
    <div class="modal fade" id="templateManagementModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title"><i class="fas fa-layer-group"></i> æ¨¡æ¿ç®¡ç†</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" id="addTemplateBtn">
                            <i class="fas fa-plus-circle"></i> æ–°å¢æ¨¡æ¿
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>æ¨¡æ¿åç§°</th>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>æ›´æ–°æ—¶é—´</th>
                                    <th class="text-end">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="templateTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 template-preview d-none" id="templatePreviewPanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-muted">æ¨¡æ¿é¢„è§ˆï¼š<span id="templatePreviewName"></span></h6>
                            <button class="btn btn-sm btn-outline-secondary" id="closeTemplatePreview">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <pre class="template-content" id="templatePreviewContent"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ¿ç¼–è¾‘ Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘æ¨¡æ¿</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <div class="mb-3">
                            <label class="form-label">æ¨¡æ¿åç§°</label>
                            <input type="text" class="form-control" id="templateNameInput" required>
                            <div class="form-text">ä»…é™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­åˆ’çº¿ï¼Œè‡ªåŠ¨é™„åŠ  `.Dockerfile` åç¼€</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä¸Šä¼  Dockerfileï¼ˆå¯é€‰ï¼‰</label>
                            <input type="file" class="form-control" id="templateFileInput" accept=".dockerfile,.txt,.tpl,.template,.Dockerfile">
                            <div class="form-text">é€‰æ‹©æ–‡ä»¶åå°†è‡ªåŠ¨è¯»å–å†…å®¹å¡«å…¥ä¸‹æ–¹ç¼–è¾‘å™¨</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ¨¡æ¿å†…å®¹</label>
                            <textarea class="form-control" id="templateContentInput" rows="12" required spellcheck="false"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveTemplateBtn">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 2000;"></div>

    <script src="static/js/jquery-3.7.1.min.js"></script>
    <script src="static/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="static/codemirror/js/codemirror.min.js"></script>
    <script src="static/codemirror/mode/yaml/yaml.min.js"></script>
    <script>
        $(function() {
            const $log = $('#buildLog');
            const $form = $('#uploadForm');
            const $configForm = $('#configForm');
            const $templateSelect = $('#templateSelect');
            const $spinner = $('.spinner');
            const $pushImage = $('#pushImage');
            const $defaultPush = $('#defaultPush');
            const $exportForm = $('#exportForm');
            const $projectType = $('#projectType');
            const $appFile = $('#appFile');
            const $fileTypeHint = $('#fileTypeHint');
            const $exportSpinner = $('#exportSpinner');
            const $templateTableBody = $('#templateTableBody');
            const templateModalEl = document.getElementById('templateModal');
            const templateModal = new bootstrap.Modal(templateModalEl);
            const templateManagementModalEl = document.getElementById('templateManagementModal');
            const templateManagementModal = new bootstrap.Modal(templateManagementModalEl);
            const configModalEl = document.getElementById('configModal');
            const configModal = new bootstrap.Modal(configModalEl);
            const $openConfigBtn = $('#openConfigBtn');
            const toastContainer = document.getElementById('toastContainer');
            const $composeForm = $('#composeForm');
            const $composeFileInput = $('#composeFileInput');
            const $composeResult = $('#composeResult');
            // åˆå§‹åŒ– CodeMirror ç¼–è¾‘å™¨
            const composeTextEditor = CodeMirror(document.getElementById('composeTextEditor'), {
                mode: 'yaml',
                theme: 'monokai',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2,
                indentWithTabs: false,
                autoRefresh: true
            });
            const $composeImagesTableBody = $('#composeImagesTable tbody');
            const $composeImageCount = $('#composeImageCount');
            const $selectAllImages = $('#selectAllImages');
            const $downloadSelectedBtn = $('#downloadSelectedBtn');
            const $composeCompress = $('#composeCompress');
            const $templateModalTitle = $('#templateModal .modal-title');
            function showToast(message, type = 'success') {
                if (!toastContainer) return;
                const level = type === 'error' ? 'danger' : type;
                const toastEl = document.createElement('div');
                toastEl.className = `toast align-items-center text-bg-${level} border-0 mb-2`;
                toastEl.setAttribute('role', 'alert');
                toastEl.setAttribute('aria-live', 'assertive');
                toastEl.setAttribute('aria-atomic', 'true');
                toastEl.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>`;
                toastContainer.appendChild(toastEl);
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
            function downloadImage(image, tag = 'latest', compress = 'none') {
                const params = new URLSearchParams({ image, tag, compress });
                return fetch(`/export-image?${params.toString()}`)
                    .then(async res => {
                        if (!res.ok) {
                            let message = 'å¯¼å‡ºå¤±è´¥';
                            try {
                                const data = await res.json();
                                message = data.error || message;
                            } catch (err) {
                                // ignore
                            }
                            throw new Error(message);
                        }
                        const disposition = res.headers.get('Content-Disposition') || '';
                        let filename = '';
                        const match = disposition.match(/filename="?([^";]+)"?/i);
                        if (match && match[1]) {
                            filename = match[1];
                        }
                        const blob = await res.blob();
                        const fallbackName = `${image.replace(/\//g, '_')}-${tag}.tar${compress === 'gzip' ? '.gz' : ''}`;
                        triggerDownload(blob, filename || fallbackName);
                    });
            }
            function triggerDownload(blob, filename) {
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = filename;
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
                URL.revokeObjectURL(url);
            }
            const $templateForm = $('#templateForm');
            const $templateNameInput = $('#templateNameInput');
            const $templateContentInput = $('#templateContentInput');
            const $templateFileInput = $('#templateFileInput');
            const $templatePreviewPanel = $('#templatePreviewPanel');
            const $templatePreviewName = $('#templatePreviewName');
            const $templatePreviewContent = $('#templatePreviewContent');
            let editingTemplate = null;
            let templateItems = [];
            let composeImages = [];

            // åŠ è½½é…ç½®
            function loadConfig() {
                return $.getJSON('/get-config')
                    .done(data => {
                        const docker = data.docker || {};
                        $('input[name="registry"]').val(docker.registry || 'docker.io');
                        $('input[name="registry_prefix"]').val(docker.registry_prefix || '');
                        $('input[name="expose_port"]').val(docker.expose_port || 8080);
                        $('input[name="username"]').val(docker.username || '');
                        $('input[name="password"]').val(docker.password || '');
                        $defaultPush.prop('checked', !!docker.default_push);
                        $pushImage.prop('checked', !!docker.default_push);
                    })
                    .fail(() => {
                        appendLog('âŒ åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸', 'error');
                    });
            }

            // åŠ è½½æ¨¡æ¿åˆ—è¡¨
            function loadTemplates() {
                return fetch('/templates')
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('åŠ è½½æ¨¡æ¿å¤±è´¥');
                        }
                        return res.json();
                    })
                    .then(data => {
                        templateItems = data.items || [];
                        renderTemplateSelect();
                        renderTemplateTable();
                    })
                    .catch(() => {
                        appendLog('âš ï¸ åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥', 'error');
                    });
            }

            function renderTemplateSelect() {
                const previous = $templateSelect.val();
                const projectType = $projectType.val();
                $templateSelect.empty();
                if (!templateItems.length) {
                    $templateSelect.append('<option value="">æš‚æ— æ¨¡æ¿</option>');
                    return;
                }
                
                // æ ¹æ®é¡¹ç›®ç±»å‹è¿‡æ»¤æ¨¡æ¿
                let filteredTemplates = templateItems;
                if (projectType === 'nodejs') {
                    // Node.js é¡¹ç›®ï¼Œä¼˜å…ˆæ˜¾ç¤º node ç›¸å…³æ¨¡æ¿
                    filteredTemplates = templateItems.filter(item => item.name.toLowerCase().includes('node'));
                    if (filteredTemplates.length === 0) {
                        filteredTemplates = templateItems; // å¦‚æœæ²¡æœ‰ node æ¨¡æ¿ï¼Œæ˜¾ç¤ºå…¨éƒ¨
                    }
                } else if (projectType === 'jar') {
                    // JAR é¡¹ç›®ï¼Œæ’é™¤ node æ¨¡æ¿
                    filteredTemplates = templateItems.filter(item => !item.name.toLowerCase().includes('node'));
                    if (filteredTemplates.length === 0) {
                        filteredTemplates = templateItems;
                    }
                }
                
                filteredTemplates.forEach(item => {
                    const selected = previous === item.name ? 'selected' : '';
                    $templateSelect.append(`<option value="${item.name}" ${selected}>${item.name}</option>`);
                });
                
                // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
                if (!$templateSelect.val() && filteredTemplates.length > 0) {
                    $templateSelect.val(filteredTemplates[0].name);
                }
            }

            function renderTemplateTable() {
                $templateTableBody.empty();
                if (!templateItems.length) {
                    $templateTableBody.append('<tr><td colspan="5" class="text-center text-muted">æš‚æ— æ¨¡æ¿ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®æ–°å¢</td></tr>');
                    return;
                }
                templateItems.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.filename}</td>
                            <td>${formatBytes(item.size)}</td>
                            <td>${formatTime(item.updated_at)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-secondary me-2 btn-template-preview" data-name="${item.name}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary me-2 btn-template-edit" data-name="${item.name}">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-template-delete" data-name="${item.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                    $templateTableBody.append(row);
                });
            }

            function formatBytes(bytes) {
                if (bytes === undefined || bytes === null) return '-';
                if (bytes === 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let idx = 0;
                let value = bytes;
                while (value >= 1024 && idx < units.length - 1) {
                    value /= 1024;
                    idx++;
                }
                return `${value.toFixed(value < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
            }

            function formatTime(timeStr) {
                if (!timeStr) return '-';
                try {
                    return new Date(timeStr).toLocaleString();
                } catch {
                    return timeStr;
                }
            }

            function fetchTemplateContent(name) {
                return fetch(`/templates?name=${encodeURIComponent(name)}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('åŠ è½½æ¨¡æ¿å¤±è´¥');
                        }
                        return res.json();
                    });
            }

            function previewTemplate(name) {
                if (!name) {
                    $templatePreviewPanel.addClass('d-none');
                    return;
                }
                fetchTemplateContent(name)
                    .then(data => {
                        $templatePreviewName.text(data.name || name);
                        $templatePreviewContent.text(data.content || '');
                        $templatePreviewPanel.removeClass('d-none');
                    })
                    .catch(() => {
                        $templatePreviewName.text(name);
                        $templatePreviewContent.text('âŒ æ— æ³•åŠ è½½æ¨¡æ¿å†…å®¹');
                        $templatePreviewPanel.removeClass('d-none');
                    });
            }

            function templateRequest(method, payload) {
                return fetch('/templates', {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload || {})
                }).then(async res => {
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                    }
                    return data;
                });
            }

            function openTemplateModal(name = null) {
                if (!name) {
                    editingTemplate = null;
                    $templateModalTitle.text('æ–°å¢æ¨¡æ¿');
                    $templateForm[0].reset();
                    $templateFileInput.val('');
                    templateModal.show();
                    return;
                }
                fetchTemplateContent(name)
                    .then(data => {
                        editingTemplate = data.name;
                        $templateModalTitle.text('ç¼–è¾‘æ¨¡æ¿');
                        $templateForm[0].reset();
                        $templateFileInput.val('');
                        $templateNameInput.val(data.name);
                        $templateContentInput.val(data.content || '');
                        templateModal.show();
                    })
                    .catch(() => {
                        appendLog('âŒ åŠ è½½æ¨¡æ¿å†…å®¹å¤±è´¥', 'error');
                    });
            }

            $('#addTemplateBtn').on('click', () => openTemplateModal());
            $('#manageTemplateBtn').on('click', () => {
                loadTemplates().finally(() => templateManagementModal.show());
            });
            $('#closeTemplatePreview').on('click', () => $templatePreviewPanel.addClass('d-none'));
            $openConfigBtn.on('click', () => {
                loadConfig().always(() => configModal.show());
            });

            $templateFileInput.on('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    $templateContentInput.val(ev.target.result || '');
                    if (!$templateNameInput.val()) {
                        const base = (file.name || '')
                            .replace(/\.Dockerfile$/i, '')
                            .replace(/\.[^/.]+$/, '')
                            .replace(/[^a-zA-Z0-9_-]/g, '-');
                        if (base) {
                            $templateNameInput.val(base);
                        }
                    }
                };
                reader.readAsText(file);
            });

            $('#saveTemplateBtn').on('click', function() {
                const name = $templateNameInput.val().trim();
                const content = $templateContentInput.val();
                if (!name) {
                    appendLog('âŒ æ¨¡æ¿åç§°ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                if (!content.trim()) {
                    appendLog('âŒ æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                const payload = {
                    name,
                    content
                };
                if (editingTemplate) {
                    payload.original_name = editingTemplate;
                }
                const method = editingTemplate ? 'PUT' : 'POST';
                templateRequest(method, payload)
                    .then(data => {
                        const savedName = data.template?.name || name;
                        const msg = data.message || 'æ¨¡æ¿ä¿å­˜æˆåŠŸ';
                        appendLog(`âœ… ${msg}`, 'success');
                        showToast(msg, 'success');
                        templateModal.hide();
                        editingTemplate = null;
                        loadTemplates().then(() => {
                            $templateSelect.val(savedName);
                        });
                    })
                    .catch(err => {
                        appendLog(`âŒ ${err.message}`, 'error');
                        showToast(err.message || 'æ¨¡æ¿ä¿å­˜å¤±è´¥', 'error');
                    });
            });

            $templateTableBody.on('click', '.btn-template-preview', function() {
                const name = $(this).data('name');
                if (!name) return;
                previewTemplate(name);
            });

            $templateTableBody.on('click', '.btn-template-edit', function() {
                const name = $(this).data('name');
                if (!name) return;
                openTemplateModal(name);
            });

            $templateTableBody.on('click', '.btn-template-delete', function() {
                const name = $(this).data('name');
                if (!name) return;
                if (!window.confirm(`ç¡®è®¤åˆ é™¤æ¨¡æ¿ ${name} å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
                templateRequest('DELETE', { name })
                    .then(data => {
                        const msg = data.message || 'æ¨¡æ¿å·²åˆ é™¤';
                        appendLog(`âœ… ${msg}`, 'success');
                        showToast(msg, 'success');
                        loadTemplates().then(() => {
                            const current = $templateSelect.val();
                            if (current === name && templateItems.length) {
                                $templateSelect.val(templateItems[0].name);
                            } else if (!templateItems.length) {
                                previewTemplate(null);
                            }
                        });
                    })
                    .catch(err => {
                        appendLog(`âŒ ${err.message}`, 'error');
                        showToast(err.message || 'æ¨¡æ¿åˆ é™¤å¤±è´¥', 'error');
                    });
            });

            // Compose æ–‡ä»¶è¾“å…¥åˆ‡æ¢æ—¶ï¼Œå¦‚æœå·²ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨å¡«å……åˆ°ç¼–è¾‘å™¨
            $('#compose-text-tab').on('shown.bs.tab', function() {
                const file = $composeFileInput[0]?.files?.[0];
                if (file && !composeTextEditor.getValue().trim()) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        composeTextEditor.setValue(ev.target.result);
                        composeTextEditor.refresh();
                    };
                    reader.readAsText(file);
                }
                // åˆ·æ–°ç¼–è¾‘å™¨ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
                setTimeout(() => composeTextEditor.refresh(), 100);
            });

            // Compose é•œåƒè§£æ
            $composeForm.on('submit', function(e) {
                e.preventDefault();
                const file = $composeFileInput[0]?.files?.[0];
                const textContent = composeTextEditor.getValue()?.trim();
                
                if (file) {
                    // ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const content = ev.target.result;
                        parseComposeContent(content);
                    };
                    reader.onerror = () => {
                        showToast('è¯»å– compose æ–‡ä»¶å¤±è´¥', 'error');
                    };
                    reader.readAsText(file);
                } else if (textContent) {
                    // ä½¿ç”¨ç¼–è¾‘å™¨è¾“å…¥
                    parseComposeContent(textContent);
                } else {
                    showToast('è¯·ä¸Šä¼ æ–‡ä»¶æˆ–è¾“å…¥ docker-compose.yml å†…å®¹', 'error');
                }
            });

            function parseComposeContent(content) {
                fetch('/parse-compose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                })
                    .then(res => res.json().then(data => ({ ok: res.ok, data })))
                    .then(({ ok, data }) => {
                        if (!ok) {
                            throw new Error(data.error || 'è§£æå¤±è´¥');
                        }
                        composeImages = data.images || [];
                        renderComposeImages();
                        showToast(`è§£ææˆåŠŸï¼Œå…± ${composeImages.length} ä¸ªé•œåƒ`, 'success');
                    })
                    .catch(err => {
                        composeImages = [];
                        renderComposeImages();
                        showToast(err.message || 'è§£æå¤±è´¥', 'error');
                    });
            }

            function renderComposeImages() {
                $composeImagesTableBody.empty();
                if (!composeImages.length) {
                    $composeResult.addClass('d-none');
                    $composeImageCount.text('0');
                    $selectAllImages.prop('checked', false);
                    return;
                }
                $composeResult.removeClass('d-none');
                $composeImageCount.text(composeImages.length);
                composeImages.forEach((item, index) => {
                    const $row = $('<tr>');
                    const $checkboxCell = $('<td>');
                    const $checkbox = $('<input>', {
                        type: 'checkbox',
                        class: 'form-check-input compose-image-checkbox',
                        'data-index': index
                    });
                    $checkboxCell.append($checkbox);
                    $row.append($checkboxCell);
                    $row.append($('<td>').text(item.service || '-'));
                    $row.append($('<td>').text(item.image || '-'));
                    $row.append($('<td>').text(item.tag || 'latest'));
                    const $actionCell = $('<td class="text-end">');
                    const $btn = $('<button type="button" class="btn btn-sm btn-outline-primary compose-download-btn">')
                        .attr('data-index', index)
                        .append('<i class="fas fa-download"></i> ä¸‹è½½');
                    $actionCell.append($btn);
                    $row.append($actionCell);
                    $composeImagesTableBody.append($row);
                });
            }

            $selectAllImages.on('change', function() {
                const checked = $(this).is(':checked');
                $composeImagesTableBody.find('.compose-image-checkbox').prop('checked', checked);
            });

            $composeImagesTableBody.on('change', '.compose-image-checkbox', function() {
                const total = $composeImagesTableBody.find('.compose-image-checkbox').length;
                const checked = $composeImagesTableBody.find('.compose-image-checkbox:checked').length;
                $selectAllImages.prop('checked', total > 0 && total === checked);
            });

            $composeImagesTableBody.on('click', '.compose-download-btn', function() {
                const $btn = $(this);
                if ($btn.prop('disabled')) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
                
                const index = Number($btn.data('index'));
                const item = composeImages[index];
                if (!item) return;
                
                const compress = $composeCompress.val();
                const originalHtml = $btn.html();
                
                // è®¾ç½® loading çŠ¶æ€
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>ä¸‹è½½ä¸­...');
                
                downloadImage(item.image, item.tag || 'latest', compress)
                    .then(() => {
                        const msg = `é•œåƒ ${item.image}:${item.tag || 'latest'} å¯¼å‡ºæˆåŠŸ`;
                        appendLog(`âœ… ${msg}`, 'success');
                        showToast(msg, 'success');
                    })
                    .catch(err => {
                        const msg = `å¯¼å‡ºå¤±è´¥ ${item.image}:${item.tag || 'latest'}: ${err.message}`;
                        appendLog(`âŒ ${msg}`, 'error');
                        showToast(msg, 'error');
                    })
                    .finally(() => {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        $btn.prop('disabled', false).html(originalHtml);
                    });
            });

            $downloadSelectedBtn.on('click', async function() {
                const $btn = $(this);
                if ($btn.prop('disabled')) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
                
                const indexes = [];
                $composeImagesTableBody.find('.compose-image-checkbox:checked').each(function() {
                    indexes.push(Number($(this).data('index')));
                });
                if (!indexes.length) {
                    showToast('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é•œåƒ', 'error');
                    return;
                }
                const compress = $composeCompress.val();
                const total = indexes.length;
                const originalHtml = $btn.html();
                
                // è®¾ç½®æ‰¹é‡ä¸‹è½½æŒ‰é’® loading çŠ¶æ€
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>å‡†å¤‡ä¸‹è½½...');
                
                // ç¦ç”¨æ‰€æœ‰å•ä¸ªä¸‹è½½æŒ‰é’®å’Œå¤é€‰æ¡†
                $composeImagesTableBody.find('.compose-download-btn').prop('disabled', true);
                $composeImagesTableBody.find('.compose-image-checkbox').prop('disabled', true);
                $selectAllImages.prop('disabled', true);
                
                try {
                    for (let i = 0; i < indexes.length; i++) {
                        const idx = indexes[i];
                        const item = composeImages[idx];
                        if (!item) continue;
                        
                        // æ›´æ–°è¿›åº¦
                        $btn.html(`<span class="spinner-border spinner-border-sm me-1"></span>ä¸‹è½½ä¸­ (${i + 1}/${total})...`);
                        
                        try {
                            await downloadImage(item.image, item.tag || 'latest', compress);
                            const msg = `é•œåƒ ${item.image}:${item.tag || 'latest'} å¯¼å‡ºæˆåŠŸ`;
                            appendLog(`âœ… ${msg}`, 'success');
                            if (i === indexes.length - 1) {
                                // æœ€åä¸€ä¸ªä¸‹è½½å®Œæˆæ—¶æ˜¾ç¤ºæç¤º
                                showToast(`æ‰¹é‡ä¸‹è½½å®Œæˆï¼š${total} ä¸ªé•œåƒ`, 'success');
                            }
                        } catch (err) {
                            const msg = `å¯¼å‡ºå¤±è´¥ ${item.image}:${item.tag || 'latest'}: ${err.message}`;
                            appendLog(`âŒ ${msg}`, 'error');
                            showToast(msg, 'error');
                        }
                        
                        // ä¸‹è½½é—´éš”ï¼Œé¿å…æœåŠ¡å™¨å‹åŠ›è¿‡å¤§
                        if (i < indexes.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                } finally {
                    // æ¢å¤æ‰€æœ‰æŒ‰é’®çŠ¶æ€
                    $btn.prop('disabled', false).html(originalHtml);
                    $composeImagesTableBody.find('.compose-download-btn').prop('disabled', false);
                    $composeImagesTableBody.find('.compose-image-checkbox').prop('disabled', false);
                    $selectAllImages.prop('disabled', false);
                }
            });

            // é¡¹ç›®ç±»å‹åˆ‡æ¢æ—¶æ›´æ–°æ–‡ä»¶é€‰æ‹©å™¨å’Œæ¨¡æ¿åˆ—è¡¨
            $projectType.on('change', function() {
                const type = $(this).val();
                if (type === 'nodejs') {
                    $appFile.attr('accept', '.zip,.tar,.tar.gz,.tgz');
                    $fileTypeHint.text('æ”¯æŒ .zipã€.tarã€.tar.gz å‹ç¼©åŒ…');
                } else {
                    $appFile.attr('accept', '.jar,.zip,.tar,.tar.gz,.tgz');
                    $fileTypeHint.text('æ”¯æŒ .jar æ–‡ä»¶æˆ– .zipã€.tarã€.tar.gz å‹ç¼©åŒ…');
                }
                renderTemplateSelect();
            });

            // æ–‡ä»¶é€‰æ‹©åå»ºè®®é•œåƒå
            $appFile.on('change', function() {
                if (!this.files.length) return;
                const formData = new FormData();
                formData.append('jar_file', this.files[0]);

                $.ajax({
                    url: '/suggest-image-name',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.suggested_imagename) {
                            $('input[name="imagename"]').val(res.suggested_imagename);
                        }
                    },
                    error: function() {
                        appendLog('âš ï¸ è‡ªåŠ¨ç”Ÿæˆé•œåƒåå¤±è´¥', 'error');
                    }
                });
            });

            // ä¿å­˜é…ç½®
            $configForm.on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/save-config',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.message) {
                            appendLog(`âœ… ${res.message}`, 'success');
                            $pushImage.prop('checked', res.docker_config?.default_push || false);
                            showToast(res.message, 'success');
                        }
                    },
                    error: function(xhr) {
                        try {
                            const res = JSON.parse(xhr.responseText);
                            appendLog(`âŒ ${res.error}`, 'error');
                            showToast(res.error || 'ä¿å­˜é…ç½®å¤±è´¥', 'error');
                        } catch {
                            appendLog('âŒ ä¿å­˜é…ç½®å¤±è´¥', 'error');
                            showToast('ä¿å­˜é…ç½®å¤±è´¥', 'error');
                        }
                    }
                });
            });


            // æ„å»ºå¤„ç†
            $form.on('submit', function(e) {
                e.preventDefault();

                $log.empty();
                $spinner.show();
                $('button[type="submit"]').prop('disabled', true);

                const formData = new FormData(this);


                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        appendLog(res.message);
                        // å¾ªç¯è°ƒç”¨æ—¥å¿—
                        pollLogs(res.build_id)
                    },
                    complete: function() {
                        $spinner.hide();
                        $('button[type="submit"]').prop('disabled', false);
                        $log.scrollTop($log[0].scrollHeight);
                    },
                    error: function(xhr) {
                        $spinner.hide();
                        $('button[type="submit"]').prop('disabled', false);
                        try {
                            const res = JSON.parse(xhr.responseText);
                            appendLog(`âŒ ${res.error}`, 'error');
                        } catch {
                            appendLog('âŒ ä¸Šä¼ æˆ–æ„å»ºå¤±è´¥', 'error');
                        }
                    }
                });
            });

            // å¯¼å‡ºé•œåƒ
            $exportForm.on('submit', function(e) {
                e.preventDefault();
                const image = $('input[name="export_image"]').val().trim();
                const tag = $('input[name="export_tag"]').val().trim() || 'latest';
                const compress = $('select[name="export_compress"]').val();

                if (!image) {
                    appendLog('âŒ å¯¼å‡ºé•œåƒåç§°ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                $exportSpinner.removeClass('d-none');
                $exportForm.find('button[type="submit"]').prop('disabled', true);

            downloadImage(image, tag, compress)
                .then(() => {
                    const msg = `é•œåƒ ${image}:${tag} å¯¼å‡ºæˆåŠŸ`;
                    appendLog(`âœ… ${msg}`, 'success');
                    showToast(msg, 'success');
                })
                    .catch(err => {
                    appendLog(`âŒ å¯¼å‡ºå¤±è´¥: ${err.message}`, 'error');
                    showToast(err.message || 'å¯¼å‡ºå¤±è´¥', 'error');
                    })
                    .finally(() => {
                        $exportSpinner.addClass('d-none');
                        $exportForm.find('button[type="submit"]').prop('disabled', false);
                    });
            });

            async function pollLogs(buildId) {
                const logArea = document.getElementById('log');
                let lastLength = 0;

                while (true) {
                    try {
                        const res = await fetch(`/get-logs?build_id=${encodeURIComponent(buildId)}`);
                        if (!res.ok) break;
                        const logs = await res.text();
                        if (logs.length > lastLength) {
                              appendLog(logs);
                              lastLength = logs.length;
                        }

                        // æ£€æŸ¥æ„å»ºæ˜¯å¦ç»“æŸï¼ˆå¯é€‰ï¼šé€šè¿‡é¢å¤–æ¥å£åˆ¤æ–­çŠ¶æ€ï¼‰
                        await new Promise(resolve => setTimeout(resolve, 500)); // 500ms è½®è¯¢
                    } catch (e) {
                        console.error("æ—¥å¿—è½®è¯¢å¤±è´¥:", e);
                        break;
                    }
                }
            }



            // === æ—¥å¿—ç®¡ç†å™¨ ===
            const LogManager = {
                logs: [],
                lineNumber: 0,
                autoScroll: true,
                showLineNumber: true,
                showTimestamp: true,
                searchTerm: '',
                levelFilter: 'all',

                init() {
                    this.bindEvents();
                    this.updateStats();
                },

                bindEvents() {
                    // æœç´¢
                    $('#logSearch').on('input', (e) => {
                        this.searchTerm = e.target.value.toLowerCase();
                        this.render();
                    });

                    // çº§åˆ«è¿‡æ»¤
                    $('#logLevel').on('change', (e) => {
                        this.levelFilter = e.target.value;
                        this.render();
                    });

                    // è‡ªåŠ¨æ»šåŠ¨åˆ‡æ¢
                    $('#autoScrollToggle').on('click', () => {
                        this.autoScroll = !this.autoScroll;
                        $('#autoScrollToggle').toggleClass('active', this.autoScroll);
                        if (this.autoScroll) this.scrollToBottom();
                    });

                    // è¡Œå·åˆ‡æ¢
                    $('#lineNumberToggle').on('click', () => {
                        this.showLineNumber = !this.showLineNumber;
                        $('#lineNumberToggle').toggleClass('active', this.showLineNumber);
                        this.render();
                    });

                    // æ—¶é—´æˆ³åˆ‡æ¢
                    $('#timestampToggle').on('click', () => {
                        this.showTimestamp = !this.showTimestamp;
                        $('#timestampToggle').toggleClass('active', this.showTimestamp);
                        this.render();
                    });

                    // å¤åˆ¶æ—¥å¿—
                    $('#copyLog').on('click', () => {
                        const text = this.logs.map(log => log.text).join('\n');
                        navigator.clipboard.writeText(text).then(() => {
                            this.showToast('âœ… æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        });
                    });

                    // ä¸‹è½½æ—¥å¿—
                    $('#downloadLog').on('click', () => {
                        this.downloadLogs();
                    });

                    // æ¸…ç©ºæ—¥å¿—
                    $('#clearLog').on('click', () => {
                        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                            this.clear();
                        }
                    });

                    // é»˜è®¤æ¿€æ´»æŒ‰é’®çŠ¶æ€
                    $('#autoScrollToggle, #lineNumberToggle, #timestampToggle').addClass('active');
                },

                addLog(text, level = 'info') {
                    const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                    this.lineNumber++;
                    
                    // æ™ºèƒ½æ£€æµ‹æ—¥å¿—çº§åˆ«
                    if (!level || level === 'info') {
                        if (text.includes('âŒ') || text.includes('é”™è¯¯') || text.includes('å¤±è´¥') || text.includes('ERROR')) {
                            level = 'error';
                        } else if (text.includes('âœ…') || text.includes('æˆåŠŸ') || text.includes('å®Œæˆ') || text.includes('SUCCESS')) {
                            level = 'success';
                        } else if (text.includes('âš ï¸') || text.includes('è­¦å‘Š') || text.includes('WARNING')) {
                            level = 'warning';
                        }
                    }

                    this.logs.push({
                        number: this.lineNumber,
                        timestamp,
                        text,
                        level
                    });

                    this.updateStats();
                    this.renderNewLine(this.logs[this.logs.length - 1]);
                    if (this.autoScroll) this.scrollToBottom();
                },

                renderNewLine(log) {
                    // æ£€æŸ¥æ˜¯å¦ç¬¦åˆè¿‡æ»¤æ¡ä»¶
                    if (!this.shouldShowLog(log)) return;

                    const $line = this.createLogLine(log);
                    $log.append($line);
                },

                render() {
                    $log.empty();
                    const filteredLogs = this.logs.filter(log => this.shouldShowLog(log));
                    filteredLogs.forEach(log => {
                        const $line = this.createLogLine(log);
                        $log.append($line);
                    });
                    this.updateStats();
                    if (this.autoScroll) this.scrollToBottom();
                },

                createLogLine(log) {
                    const $line = $('<div>').addClass('log-line').addClass(log.level);
                    
                    if (this.showLineNumber) {
                        $line.append($('<span>').addClass('log-line-number').text(log.number));
                    }

                    let content = '';
                    if (this.showTimestamp) {
                        content += `<span class="log-timestamp">[${log.timestamp}]</span>`;
                    }
                    
                    let text = log.text;
                    // é«˜äº®æœç´¢è¯
                    if (this.searchTerm) {
                        const regex = new RegExp(`(${this.searchTerm})`, 'gi');
                        text = text.replace(regex, '<mark>$1</mark>');
                        if (log.text.toLowerCase().includes(this.searchTerm)) {
                            $line.addClass('highlight');
                        }
                    }
                    
                    content += `<span class="log-content">${text}</span>`;
                    $line.html($line.html() + content);
                    
                    return $line;
                },

                shouldShowLog(log) {
                    // çº§åˆ«è¿‡æ»¤
                    if (this.levelFilter !== 'all' && log.level !== this.levelFilter) {
                        return false;
                    }
                    // æœç´¢è¿‡æ»¤
                    if (this.searchTerm && !log.text.toLowerCase().includes(this.searchTerm)) {
                        return false;
                    }
                    return true;
                },

                updateStats() {
                    const total = this.logs.length;
                    const filtered = this.logs.filter(log => this.shouldShowLog(log)).length;
                    $('#logCount').text(total);
                    $('#filteredCount').text(filtered);
                },

                scrollToBottom() {
                    $log.scrollTop($log[0].scrollHeight);
                },

                clear() {
                    this.logs = [];
                    this.lineNumber = 0;
                    $log.empty();
                    this.updateStats();
                    this.showToast('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º');
                },

                downloadLogs() {
                    const text = this.logs.map(log => {
                        let line = '';
                        if (this.showLineNumber) line += `${log.number} `;
                        if (this.showTimestamp) line += `[${log.timestamp}] `;
                        line += log.text;
                        return line;
                    }).join('\n');

                    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `jar2docker-build-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.log`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showToast('ğŸ’¾ æ—¥å¿—å·²ä¸‹è½½');
                },

                showToast(message) {
                    const $toast = $('<div>')
                        .css({
                            position: 'fixed',
                            top: '20px',
                            right: '20px',
                            background: '#28a745',
                            color: 'white',
                            padding: '12px 20px',
                            borderRadius: '4px',
                            zIndex: 9999,
                            boxShadow: '0 4px 12px rgba(0,0,0,0.2)'
                        })
                        .text(message)
                        .appendTo('body');
                    
                    setTimeout(() => $toast.fadeOut(() => $toast.remove()), 2000);
                }
            };

            // åˆå§‹åŒ–æ—¥å¿—ç®¡ç†å™¨
            LogManager.init();

            // å…¼å®¹æ—§çš„appendLogå‡½æ•°
            function appendLog(text, type = '') {
                LogManager.addLog(text, type);
            }

            // åˆå§‹åŒ–
            loadConfig();
            loadTemplates();
        });
    </script>
</body>
</html>